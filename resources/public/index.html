<html>
<head>
    <title>Clojure Fiddle</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css"></link>
    <link rel="stylesheet" href="/css/bootstrap-theme.min.css"></link>
    <link rel="stylesheet" href="/css/font-awesome.min.css"></link>
    <link rel="stylesheet" href="/css/screen.css"></link>
    <link rel="stylesheet" href="/js/codemirror-3.19/lib/codemirror.css"></link>
    <link rel="stylesheet" href="/js/codemirror-3.19/theme/paraiso-light.css"></link>
</head>
<body>
    <div class="navbar navbar-inverse navbar-static-top" role="navigation">
      <div >
        <div class="navbar-header">

          <a class="navbar-brand" href="#">(clj-fiddle)</a>




        </div>

        <button id="run" type="button" class="btn btn-default btn-sm">
            <span class="fa fa-github fa-lg"></span> Login
        </button>

        <button id="save" type="button" class="btn btn-default btn-sm">
            <span class="glyphicon glyphicon-save"></span> Save
          </button>

        <button id="run" type="button" class="btn btn-default btn-sm">
            <span class="glyphicon glyphicon-play"></span> Run
        </button>
      </div>
    </div>
    <div class="">
        <div id="code-container"></div>
        <div id="separator"></div>
        <div id="result-container"></div>
    </div>

    <script type="text/javascript" src="/js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/js/codemirror-3.19/lib/codemirror.js"></script>
    <script type="text/javascript" src="/js/codemirror-3.19/mode/clojure/clojure.js"></script>
    <script type="text/javascript" src="/js/codemirror-3.19/addon/edit/closebrackets.js"></script>
    <script type="text/javascript" src="/js/codemirror-3.19/addon/edit/matchbrackets.js"></script>

    <script>

    var request = function(method, url, data) {
        return $.ajax({
            type: method,
            url: url,
            data: data?JSON.stringify(data):undefined,
            contentType: 'application/json',
            dataType: 'json'
        });
    }

    $(document).ready(function(){

        function editors(initial){
            var code = CodeMirror($('#code-container')[0], {
                value: initial,
                mode: 'clojure',
                theme: 'paraiso-light',
                matchBrackets: true,
                autoCloseBrackets: true,
                lineNumbers: true,
                autofocus: true
            });

            var result = CodeMirror($('#result-container')[0], {
                value: '',
                mode: 'clojure',
                theme: 'paraiso-dark',
                // lineNumbers: true,
                readOnly: true,
                lineWrapping: true
            });

            $('button#run').click(function (){
                request('post', '/api/eval', {code: code.getValue()}).then(function (data){
                    console.log("success", data);
                    if(data.error) {
                        result.setValue("Error: "+data.message || 'nil');
                    } else {
                        if(data.stdout){
                            result.setValue([data.stdout, "> "+ (data.result || 'nil')].join('\n'));
                        } else {
                            result.setValue("> "+(data.result || 'nil'));    
                        }
                    }

                }).fail(function (err){
                    console.log("failure",err);
                })
            }).click();

            $('button#save').click(function(){
                var data = {
                    "description": "A fiddle from clj-fiddle.com",
                    "public": true,
                    "files": {
                        "main.clj": {
                            "content": code.getValue()
                        }
                    }
                }

                if(document.location.hash){
                    request('patch', 'https://api.github.com/gists/'+document.location.hash.substr(2), data)
                    .then(function(data){
                        console.log("success", data);
                    }).fail(function(err){
                        console.log("failure",err);
                    });
                } else {
                    request('post', 'https://api.github.com/gists', data).then(function(data){
                        document.location.hash = '/'+data.id;
                        console.log("success", data);
                    }).fail(function(err){
                        console.log("failure",err);
                    });
                }
            });

            // $('div#separator').on('mousedown', function(e){
            //     var //w = $(this).outerWidth(),
            //         h = $(this).outerHeight();
            //     $(this).on('mousemove', function(e){
            //         //console.log(e.pageX, e.pageY);
            //         $(this).offset({
            //             top: e.pageY - h / 2,
            //             //left: e.pageX - w / 2,
            //         })
            //     });
            // });

            // $('div#separator').on('mouseup', function(e){
            //     $('div#separator').off('mousemove');
            // });
        }

        if(document.location.hash){
            request('get', 'https://api.github.com/gists/'+document.location.hash.substr(2))
            .then(function(data){
                editors(data.files['main.clj'].content);
            })
        } else {
            editors('(clojure.string/join " " (map name [:welcome :to "clj-fiddle" :!]))');
        }



    });


</script>
</body>
</html>
